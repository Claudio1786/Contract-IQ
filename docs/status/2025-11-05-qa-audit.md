## QA & Product Audit — 2025-11-05

> Status updated 2025-11-06 23:55 PT

### Summary
- Core contract intelligence slice is wired end-to-end: FastAPI `/contracts/ingest` processes fixtures, emits analytics events, and the Next.js contract detail view renders clause intelligence, risk posture, obligations, and LLM playbook prompts.
- Portfolio dashboard now aggregates SaaS, Healthcare BAA, Public Sector SOW, and NIL fixtures with KPI cards, alerts feed, and vertical breakdowns backed by Vitest coverage.
- Alert scheduler service + FastAPI routes ship with pytest coverage (`apps/api/tests/test_alert_scheduler.py`), delivering renewal/risk/obligation alerts to logging notifiers and manual trigger/status endpoints.
- Shared packages (`@contract-iq/prompts`, `@contract-iq/analytics`, `@contract-iq/ui`) compile and test cleanly; ingestion service integration tests and web Vitest suite pass. Demo seeding CLI (`pnpm demo:seed`) produces reproducible QA snapshots.
- 2025-11-06 validation run re-confirmed UI, prompts, analytics, and web Vitest suites plus API pytest using the direct pnpm-installed Vitest binary path on Windows.
- Next.js production build now passes after aligning route param typing and playbook data guards; the landing page served locally at `http://localhost:3000` for sanity verification.
- Contract dossier UX now includes a branded loading skeleton, exponential-backoff error boundary, and tone-aware empty states; new Vitest suites cover skeleton semantics, error retries, and empty messaging regressions.
- Terraform scaffold for Azure Container Apps, Postgres Flexible Server, and Key Vault is in place (`infra/terraform/**/*`), seeding database secrets and managed identity access policies.
- Workspace-level QA continues to rely on direct binary invocation (documented in `docs/dev-cli-workaround.md`). Poetry 2.2.1 has been reinstalled for this session to keep backend pytest green.
- Conclusion: **Still pre-deploy** — Slack/email delivery, alert persistence, Terraform plan/apply automation, and CI workflows remain before MVP is deployable.

#### Update — 2025-11-12 09:15 PT
- Completed the final Stage 1 production build validation by running `node ..\\..\\node_modules\\.pnpm\\next@15.5.6_react-dom@18.3.1_react@18.3.1__react@18.3.1\\node_modules\\next\\dist\\bin\\next build` from `apps/web`; build compiled in 2.3 s and generated all five static routes without warnings.
- Re-confirmed environment readiness immediately beforehand via `pnpm install --frozen-lockfile` and `py -m poetry install --no-root` (API workspace) — no dependency drift detected.
- Direct pnpm script invocation (`pnpm --filter @contract-iq/web build`) still launches an interactive `cmd.exe` session on Windows shells; continue using the explicit Node binary path until the CLI wrapper is remediated.
- Next actions: consolidate Stage 1 validation evidence across docs/status + status.log, prep commit packaging, and stage pull request copy that cites the complete QA matrix.

### Context Snapshot — 2025-11-06 23:55 PT
- Source already pulls live fixture data: `apps/web/app/contracts/[templateId]/page.tsx` calls `fetchContract` to POST against `/contracts/ingest`, returning the structured payload served by FastAPI fixtures.
- `ContractDetail` renders clause cards, risks, playbook prompts, and obligations with ContractSkeleton loading states, branded empty messaging, and an exponential-backoff retry boundary; analytics instrumentation and navigation enhancements remain outstanding.
- Working tree intentionally dirty with in-flight documentation updates and prior web fixes; dependency manifests remain unchanged (`pnpm-lock.yaml` untouched during 2025-11-06 session).
- Agile next step focuses on hardening the `/contracts/[templateId]` dossier experience in alignment with Sprint Goal #2 and launch readiness criteria.

### Validation Snapshot
| Surface | Commands | Result |
| --- | --- | --- |
| UI package | `node ../../node_modules/.pnpm/vitest@2.1.9_@types+node@22.19.0/node_modules/vitest/vitest.mjs run` | ✅ |
| Prompts package | `node ../../node_modules/.pnpm/vitest@2.1.9_@types+node@22.19.0/node_modules/vitest/vitest.mjs run` | ✅ |
| Analytics package | `node ../../node_modules/.pnpm/vitest@2.1.9_@types+node@22.19.0/node_modules/vitest/vitest.mjs run` | ✅ |
| Web app tests | `node ../../node_modules/.pnpm/vitest@2.1.9_@types+node@22.19.0/node_modules/vitest/vitest.mjs run` *(Vite CJS warning persists)* | ✅ |
| Web app build | `node ..\\..\\node_modules\\.pnpm\\next@15.5.6_react-dom@18.3.1_react@18.3.1__react@18.3.1\\node_modules\\next\\dist\\bin\\next build` | ✅ |
| Landing page sanity | `Invoke-WebRequest -Uri http://localhost:3000 -UseBasicParsing` | ✅ |
| API | `py -m poetry run pytest` | ✅ |

> Outstanding warnings: Vite CJS API deprecation logs during Vitest; FastAPI `on_event` deprecation during pytest; direct pnpm Vitest path required on Windows shells. `pnpm run build` still fails on PowerShell due to `next` binary resolution—invoke the absolute `node …/next/dist/bin/next build` path until CLI friction is resolved. Stop the locally started Next.js server (`next start`) after demo verification to avoid port conflicts.

### Contract Intelligence UI Hardening Progress — 2025-11-06 23:55 PT
- Implemented `ContractSkeleton` with `aria-busy` assistance, shimmer placeholders, and layout parity (clause cards at 120px, panels at 80px) for `/contracts/[templateId]/loading`.
- Added `apps/web/app/contracts/[templateId]/error.tsx` retry boundary with exponential backoff (250ms → 500ms → 1000ms), disabled state feedback, and support escalation copy after three attempts.
- Extended `ContractDetail` with tone-based empty states (`EmptyMessage` component), consistent section headings, and accessible region semantics; ensures null-safe rendering when playbook, risks, or obligations are absent.
- Expanded Vitest coverage: new suites for skeleton accessibility semantics, empty state messaging, and retry boundary behavior (with fake timers + console error suppression).
- Validation artifacts captured: web Vitest (11 tests) and targeted Next.js production build via absolute binary path, API pytest reaffirmed post-UI updates.

### Completed Backlog Reference (Troubleshooting Anchor)
| Item | Completion Date | Evidence | Regression Guard |
| --- | --- | --- | --- |
| Workspace scaffold + dependency tooling | 2025-11-05 | Commit `2c1dbea`; roadmap Status Checkpoint. | `pnpm install --frozen-lockfile`, Turbo tasks (to be wired into CI). |
| Multi-vertical ingestion + dashboard metrics | 2025-11-05 | Commit `ff9a47a`; portfolio Vitest suite. | `node ../../node_modules/.pnpm/vitest@2.1.9_@types+node@22.19.0/node_modules/vitest/vitest.mjs run` (apps/web). |
| Demo seeding CLI + docs refresh | 2025-11-05 | `pnpm demo:seed`; `docs/demo-environment-plan.md`. | Manual runbook; to be automated in CI smoke test. |
| Alert scheduler service + API routes | 2025-11-05 | `apps/api/contract_iq/services/alerts.py`; pytest suite `apps/api/tests/test_alert_scheduler.py`. | `py -m poetry run pytest`. |
| Terraform Azure scaffold (Container App, Postgres, Key Vault) | 2025-11-05 | `infra/terraform/main.tf`; modules `container_app`, `postgres`, `key_vault`. | `terraform fmt -check`, `terraform validate` (to be wired into CI). |
| Iteration validation sanity pass | 2025-11-06 | UI/Prompts/Analytics/Web Vitest + API pytest outputs (see Validation Snapshot). | Re-run commands in Validation Snapshot; capture warnings for regression triage. |

> Store regressions against the above anchors to accelerate root cause analysis during QA triage.

### Product Capability Gaps vs Competitors
- Outbound alerting delivery channels (Slack/email) are still placeholders; dispatcher currently logs messages.
- Alert persistence/audit and SLA monitoring remain unimplemented.
- NIL-specific incentives/compliance deep-dives are not yet exposed beyond current KPI rollups.

### Next Iteration Focus
1. **Contract Intelligence UI Hardening** – Mature `/contracts/[templateId]` against the live ingest endpoint (schema audit, loading/error UX, null-safe rendering, Vitest coverage, snapshot baselines, analytics instrumentation, UX review).
2. **Portfolio Dashboard & Alerts** – Integrate Slack/email transports, persist dispatch history, and expose health telemetry.
3. **Infrastructure Execution** – Validate Terraform plan/apply, wire deployment workflows, blob storage ingestion per demo plan.
4. **CI Hardening & CLI Tooling** – Resolve Windows CLI path friction and Vite CJS warnings, ensure repeatable QA commands.

### Contract Intelligence UI Hardening Plan
**Objective:** Ship a production-ready dossier experience that hydrates from `/contracts/ingest`, provides resilient UX states, and instruments negotiation insights ahead of launch.

**Action Items**
- **Data contracts & fixtures**: Enumerate schema for all demo templates via `/contracts/ingest`; capture typed fixtures (mocks) for testing; document any schema drift versus UI expectations.
- **UI hardening**: Wrap fetches with meaningful error + empty states, introduce loading skeletons/Suspense boundaries, ensure clause/risk/playbook/obligation cards tolerate null or missing values.
- **Instrumentation & analytics**: Emit client-side events for clause expansions, playbook prompt generation, and alert dismissals to feed go-live dashboards.
- **Testing**: Extend Vitest coverage for `fetchContract` error paths and UI guards; add component snapshots seeded with fixture mocks to guard regression; consider integration test harness via Playwright for dossier flows.
- **Docs & QA**: Update iteration plan and runbook with hydration behavior, acceptance criteria, and a Definition of Ready/Done checklist.

**Definition of Ready (DoR)**
- API fixture schema reviewed and captured in typed contracts.
- UX requirements reviewed with design/PM stakeholders (loading skeleton style, error messaging tone, analytics events).
- Test data/mocks available for Vitest and integration suites.

**Definition of Done (DoD)**
- `/contracts/[templateId]` renders successfully across all demo templates with no console errors or missing data states.
- Loading, error, and empty states validated manually and covered by tests.
- Analytics events observed in local telemetry logs.
- Documentation (QA audit, iteration plan, roadmap) updated with outcomes and follow-up tasks.

### Schema Audit — 2025-11-06 23:40 PT
- Captured deterministic fixture responses for all demo templates (`saas-msa`, `saas-dpa`, `healthcare-baa`, `public-sector-sow`, `nil-athlete-agreement`) via new `@contract-iq/fixtures` package. Helpers expose `getContractFixture` and `createApiContractResponse` for Vitest suites and Storybook scenarios.
- Observed schema consistencies: every payload ships `metadata.renewal`, clause `playbook` guidance with `stakeholders[]`, and risk/obligation objects matching UI expectations.
- Edge cases documented for UI hardening:
  - `obligations[].due` uses `null` when open-ended (SOW agency obligation).
  - NIL negotiation payload uniquely includes `personaNotes` keyed by stakeholder persona.
  - SaaS DPA financials include zero-fee structures and empty incentives arrays.
- Updated tests now rely on typed fixtures, ensuring clauses/playbook fallbacks remain synchronized with ingestion payloads.

### Action Items
- Track progress via new iteration backlog (see `docs/status/2025-11-05-iteration-plan.md`).
- Maintain daily QA cadence using documented direct command invocations and `pnpm demo:seed` snapshots.
- Run `terraform fmt -check`, `terraform validate`, and capture plan artifacts for review once credentials are configured.
- Close remaining capability gaps before drafting deploy plan / demo script.
- Migrate FastAPI startup/shutdown hooks to lifespan handlers to remove `on_event` deprecation warnings.
